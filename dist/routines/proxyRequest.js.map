{"version":3,"file":"proxyRequest.js","names":["log","Logger","child","namespace","defaultChromeHeaders","accept","appendDefaultChromeHeaders","request","nextHeaders","headers","host","URL","url","hostname","isNavigationRequest","proxyRequest","proxyRequestConfiguration","page","proxyUrl","startsWith","continue","debug","body","postData","method","puppeteerCookies","getAllCookies","cookies","cookieJar","CookieJar","deserializeSync","map","puppeteerCookie","formatPuppeteerCookieAsToughCookie","rejectPublicSuffixes","storeType","version","getCookieString","promisify","bind","setCookie","gotCookieJar","rawCookie","ignoreError","agent","http","HttpProxyAgent","https","HttpsProxyAgent","response","got","followRedirect","responseType","retry","throwHttpErrors","error","serializeError","abort","Error","respond","status","statusCode"],"sources":["../../src/routines/proxyRequest.js"],"sourcesContent":["// @flow\r\n\r\nimport {\r\n  promisify,\r\n} from 'util';\r\nimport type {\r\n  Request,\r\n} from 'puppeteer';\r\nimport got from 'got';\r\nimport {\r\n  CookieJar,\r\n} from 'tough-cookie';\r\nimport {\r\n  serializeError,\r\n} from 'serialize-error';\r\nimport HttpProxyAgent from 'http-proxy-agent';\r\nimport HttpsProxyAgent from 'https-proxy-agent';\r\nimport {\r\n  formatPuppeteerCookieAsToughCookie,\r\n} from '../utilities';\r\nimport type {\r\n  ProxyRequestConfigurationType,\r\n} from '../types';\r\nimport Logger from '../Logger';\r\nimport getAllCookies from './getAllCookies';\r\n\r\nconst log = Logger.child({\r\n  namespace: 'proxyRequest',\r\n});\r\n\r\nconst defaultChromeHeaders = {\r\n  accept: 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9',\r\n  'accept-encoding': 'gzip, deflate, br',\r\n  'accept-language': 'en',\r\n};\r\n\r\n/**\r\n * @see https://github.com/puppeteer/puppeteer/issues/5364\r\n */\r\nconst appendDefaultChromeHeaders = (request: Request) => {\r\n  let nextHeaders = {\r\n    ...defaultChromeHeaders,\r\n    ...request.headers(),\r\n    host: new URL(request.url()).hostname,\r\n  };\r\n\r\n  if (request.isNavigationRequest()) {\r\n    nextHeaders = {\r\n      'sec-fetch-mode': 'navigate',\r\n      'sec-fetch-site': 'none',\r\n      'sec-fetch-user': '?1',\r\n      ...nextHeaders,\r\n    };\r\n  } else {\r\n    nextHeaders = {\r\n      'sec-fetch-mode': 'no-cors',\r\n      'sec-fetch-site': 'same-origin',\r\n      ...nextHeaders,\r\n    };\r\n  }\r\n\r\n  return nextHeaders;\r\n};\r\n\r\nconst proxyRequest = async (proxyRequestConfiguration: ProxyRequestConfigurationType): Promise<void> => {\r\n  const {\r\n    page,\r\n    proxyUrl,\r\n    request,\r\n  } = proxyRequestConfiguration;\r\n\r\n  // e.g. data URI scheme\r\n  if (!request.url().startsWith('http://') && !request.url().startsWith('https://')) {\r\n    request.continue();\r\n\r\n    return;\r\n  }\r\n\r\n  const headers = appendDefaultChromeHeaders(request);\r\n\r\n  log.debug({\r\n    body: request.postData(),\r\n    headers,\r\n    method: request.method(),\r\n    url: request.url(),\r\n  }, 'making a request using HTTP proxy');\r\n\r\n  const puppeteerCookies = (await getAllCookies(page)).cookies;\r\n\r\n  const cookieJar = CookieJar.deserializeSync({\r\n    cookies: puppeteerCookies.map((puppeteerCookie) => {\r\n      return formatPuppeteerCookieAsToughCookie(puppeteerCookie);\r\n    }),\r\n    rejectPublicSuffixes: true,\r\n    storeType: 'MemoryCookieStore',\r\n    version: 'tough-cookie@2.0.0',\r\n  });\r\n\r\n  const getCookieString = promisify(cookieJar.getCookieString.bind(cookieJar));\r\n  const setCookie = promisify(cookieJar.setCookie.bind(cookieJar));\r\n\r\n  const gotCookieJar = {\r\n    getCookieString: (url) => {\r\n      return getCookieString(url);\r\n    },\r\n    setCookie: (rawCookie: string, url: string) => {\r\n      return setCookie(\r\n        rawCookie,\r\n        url,\r\n        {\r\n          ignoreError: true,\r\n        },\r\n      );\r\n    },\r\n  };\r\n\r\n  let agent;\r\n\r\n  if (proxyRequestConfiguration.agent) {\r\n    agent = proxyRequestConfiguration.agent;\r\n  } else if (proxyUrl) {\r\n    agent = {\r\n      http: new HttpProxyAgent(proxyUrl.http || proxyUrl),\r\n      https: new HttpsProxyAgent(proxyUrl.https || proxyUrl),\r\n    };\r\n  }\r\n\r\n  let response;\r\n\r\n  try {\r\n    response = await got(request.url(), {\r\n      agent,\r\n      body: request.postData(),\r\n      cookieJar: gotCookieJar,\r\n      followRedirect: false,\r\n      headers,\r\n      method: request.method(),\r\n      responseType: 'buffer',\r\n      retry: 0,\r\n      throwHttpErrors: false,\r\n    });\r\n  } catch (error) {\r\n    log.error({\r\n      error: serializeError(error),\r\n    }, 'could not complete HTTP request due to an error');\r\n\r\n    request.abort();\r\n\r\n    return;\r\n  }\r\n\r\n  if (!response) {\r\n    throw new Error('response object is not present.');\r\n  }\r\n\r\n  await request.respond({\r\n    body: response.body,\r\n    headers: response.headers,\r\n    status: response.statusCode,\r\n  });\r\n};\r\n\r\nexport default async (proxyRequestConfiguration: ProxyRequestConfigurationType) => {\r\n  try {\r\n    await proxyRequest(proxyRequestConfiguration);\r\n  } catch (error) {\r\n    log.error({\r\n      error: serializeError(error),\r\n    }, 'could not proxy request due to an error');\r\n\r\n    proxyRequestConfiguration.request.abort();\r\n  }\r\n};\r\n"],"mappings":";;;;;;AAEA;AAMA;AACA;AAGA;AAGA;AACA;AACA;AAMA;AACA;AAA4C;;AAE5C,MAAMA,GAAG,GAAGC,eAAM,CAACC,KAAK,CAAC;EACvBC,SAAS,EAAE;AACb,CAAC,CAAC;AAEF,MAAMC,oBAAoB,GAAG;EAC3BC,MAAM,EAAE,8HAA8H;EACtI,iBAAiB,EAAE,mBAAmB;EACtC,iBAAiB,EAAE;AACrB,CAAC;;AAED;AACA;AACA;AACA,MAAMC,0BAA0B,GAAIC,OAAgB,IAAK;EACvD,IAAIC,WAAW,GAAG;IAChB,GAAGJ,oBAAoB;IACvB,GAAGG,OAAO,CAACE,OAAO,EAAE;IACpBC,IAAI,EAAE,IAAIC,GAAG,CAACJ,OAAO,CAACK,GAAG,EAAE,CAAC,CAACC;EAC/B,CAAC;EAED,IAAIN,OAAO,CAACO,mBAAmB,EAAE,EAAE;IACjCN,WAAW,GAAG;MACZ,gBAAgB,EAAE,UAAU;MAC5B,gBAAgB,EAAE,MAAM;MACxB,gBAAgB,EAAE,IAAI;MACtB,GAAGA;IACL,CAAC;EACH,CAAC,MAAM;IACLA,WAAW,GAAG;MACZ,gBAAgB,EAAE,SAAS;MAC3B,gBAAgB,EAAE,aAAa;MAC/B,GAAGA;IACL,CAAC;EACH;EAEA,OAAOA,WAAW;AACpB,CAAC;AAED,MAAMO,YAAY,GAAG,MAAOC,yBAAwD,IAAoB;EACtG,MAAM;IACJC,IAAI;IACJC,QAAQ;IACRX;EACF,CAAC,GAAGS,yBAAyB;;EAE7B;EACA,IAAI,CAACT,OAAO,CAACK,GAAG,EAAE,CAACO,UAAU,CAAC,SAAS,CAAC,IAAI,CAACZ,OAAO,CAACK,GAAG,EAAE,CAACO,UAAU,CAAC,UAAU,CAAC,EAAE;IACjFZ,OAAO,CAACa,QAAQ,EAAE;IAElB;EACF;EAEA,MAAMX,OAAO,GAAGH,0BAA0B,CAACC,OAAO,CAAC;EAEnDP,GAAG,CAACqB,KAAK,CAAC;IACRC,IAAI,EAAEf,OAAO,CAACgB,QAAQ,EAAE;IACxBd,OAAO;IACPe,MAAM,EAAEjB,OAAO,CAACiB,MAAM,EAAE;IACxBZ,GAAG,EAAEL,OAAO,CAACK,GAAG;EAClB,CAAC,EAAE,mCAAmC,CAAC;EAEvC,MAAMa,gBAAgB,GAAG,CAAC,MAAM,IAAAC,sBAAa,EAACT,IAAI,CAAC,EAAEU,OAAO;EAE5D,MAAMC,SAAS,GAAGC,sBAAS,CAACC,eAAe,CAAC;IAC1CH,OAAO,EAAEF,gBAAgB,CAACM,GAAG,CAAEC,eAAe,IAAK;MACjD,OAAO,IAAAC,6CAAkC,EAACD,eAAe,CAAC;IAC5D,CAAC,CAAC;IACFE,oBAAoB,EAAE,IAAI;IAC1BC,SAAS,EAAE,mBAAmB;IAC9BC,OAAO,EAAE;EACX,CAAC,CAAC;EAEF,MAAMC,eAAe,GAAG,IAAAC,eAAS,EAACV,SAAS,CAACS,eAAe,CAACE,IAAI,CAACX,SAAS,CAAC,CAAC;EAC5E,MAAMY,SAAS,GAAG,IAAAF,eAAS,EAACV,SAAS,CAACY,SAAS,CAACD,IAAI,CAACX,SAAS,CAAC,CAAC;EAEhE,MAAMa,YAAY,GAAG;IACnBJ,eAAe,EAAGzB,GAAG,IAAK;MACxB,OAAOyB,eAAe,CAACzB,GAAG,CAAC;IAC7B,CAAC;IACD4B,SAAS,EAAE,CAACE,SAAiB,EAAE9B,GAAW,KAAK;MAC7C,OAAO4B,SAAS,CACdE,SAAS,EACT9B,GAAG,EACH;QACE+B,WAAW,EAAE;MACf,CAAC,CACF;IACH;EACF,CAAC;EAED,IAAIC,KAAK;EAET,IAAI5B,yBAAyB,CAAC4B,KAAK,EAAE;IACnCA,KAAK,GAAG5B,yBAAyB,CAAC4B,KAAK;EACzC,CAAC,MAAM,IAAI1B,QAAQ,EAAE;IACnB0B,KAAK,GAAG;MACNC,IAAI,EAAE,IAAIC,uBAAc,CAAC5B,QAAQ,CAAC2B,IAAI,IAAI3B,QAAQ,CAAC;MACnD6B,KAAK,EAAE,IAAIC,wBAAe,CAAC9B,QAAQ,CAAC6B,KAAK,IAAI7B,QAAQ;IACvD,CAAC;EACH;EAEA,IAAI+B,QAAQ;EAEZ,IAAI;IACFA,QAAQ,GAAG,MAAM,IAAAC,YAAG,EAAC3C,OAAO,CAACK,GAAG,EAAE,EAAE;MAClCgC,KAAK;MACLtB,IAAI,EAAEf,OAAO,CAACgB,QAAQ,EAAE;MACxBK,SAAS,EAAEa,YAAY;MACvBU,cAAc,EAAE,KAAK;MACrB1C,OAAO;MACPe,MAAM,EAAEjB,OAAO,CAACiB,MAAM,EAAE;MACxB4B,YAAY,EAAE,QAAQ;MACtBC,KAAK,EAAE,CAAC;MACRC,eAAe,EAAE;IACnB,CAAC,CAAC;EACJ,CAAC,CAAC,OAAOC,KAAK,EAAE;IACdvD,GAAG,CAACuD,KAAK,CAAC;MACRA,KAAK,EAAE,IAAAC,8BAAc,EAACD,KAAK;IAC7B,CAAC,EAAE,iDAAiD,CAAC;IAErDhD,OAAO,CAACkD,KAAK,EAAE;IAEf;EACF;EAEA,IAAI,CAACR,QAAQ,EAAE;IACb,MAAM,IAAIS,KAAK,CAAC,iCAAiC,CAAC;EACpD;EAEA,MAAMnD,OAAO,CAACoD,OAAO,CAAC;IACpBrC,IAAI,EAAE2B,QAAQ,CAAC3B,IAAI;IACnBb,OAAO,EAAEwC,QAAQ,CAACxC,OAAO;IACzBmD,MAAM,EAAEX,QAAQ,CAACY;EACnB,CAAC,CAAC;AACJ,CAAC;AAAC,4BAEoB7C,yBAAwD,IAAK;EACjF,IAAI;IACF,MAAMD,YAAY,CAACC,yBAAyB,CAAC;EAC/C,CAAC,CAAC,OAAOuC,KAAK,EAAE;IACdvD,GAAG,CAACuD,KAAK,CAAC;MACRA,KAAK,EAAE,IAAAC,8BAAc,EAACD,KAAK;IAC7B,CAAC,EAAE,yCAAyC,CAAC;IAE7CvC,yBAAyB,CAACT,OAAO,CAACkD,KAAK,EAAE;EAC3C;AACF,CAAC;AAAA;AAAA"}